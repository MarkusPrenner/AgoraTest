<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Test</title>
    <!--
    This line imports the bundledAgoraLogic.js file generated by webpack, which contains the compiled JavaScript code.
    -->
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.22.0.js"></script>
    <script src="agora-rtm-2.2.0.min.js"></script>
</head>
<body>
<div class="row">
    <div>
        <button type="button" id="join-channel-button">Join</button>
    </div>
</div>
</body>
</html>

<script>
async function startSignaling()
{
    try {
        const appId = "c5cb1a94a80844218e4c2448dd3056ca";
        const rtmToken = '007eJxTYNj8d14Zc+b57OxrDw5WufpEhjgKODzWCtt50O6249Yzy/8qMCSbJicZJlqaJFoYWJiYGBlapJokG5mYWKSkGBuYmiUn/on5mybAx8Bws3EzEyMDEwMjEIL4HAwlqcUlpcWpRQD7pCJM';
        const rtcToken = '007eJxTYLhSW7TNpKu29uoM2XZekeasik7dwtN9b4usQlQnl77zXa7AkGyanGSYaGmSaGFgYWJiZGiRapJsZGJikZJibGBqlpy4I/ZvmgAfA8PCZyrMjAyMDCxADOIzgUlmMMkCJrkZSlKLS5IzEvPyUnM4wJzS4tQiACufJQQ=';
        
        const userId = "testuser";
        const channelName = "testchannel";

        const { RTM } = AgoraRTM;
        const rtmClient = new RTM(appId, userId);
        registerEventHandlers(rtmClient);
        
        console.log('attempting login');
        const result = await rtmClient.login({ token: rtmToken });
        console.log('login success');
        
        console.log('creating stream channel');
        const streamChannel = rtmClient.createStreamChannel(channelName);
        console.log('stream channel created');

        const channelJoinOptions = {
            token: rtcToken,
        };
        
        try {
            console.log('joining channel');
            const result = await streamChannel.join(channelJoinOptions); // operation fails here
            console.log('channel joined');
        } catch (status) {
            const { operation, reason, errorCode } = status;
            console.log(`${operation} failed, ErrorCode: ${errorCode}, due to: ${reason}.`);
        }
    } catch (error) {
        console.error(error);
    }
}

function registerEventHandlers(rtmClient) {
    rtmClient.addEventListener("message", event => {
        showMessage(event.publisher, event.message);
    });

    // Presence event handler.
    rtmClient.addEventListener("presence", event => {
        if (event.eventType === "SNAPSHOT") {
            showMessage("INFO", "I Join");
        }
        else {
            showMessage("INFO", event.publisher + " is " + event.eventType);
        }
    });

    // Connection state changed event handler.
    rtmClient.addEventListener("status", event => {
        // The current connection state.
        const currentState = event.state;
        // The reason why the connection state changes.
        const changeReason = event.reason;
        showMessage("INFO", JSON.stringify(event));
    });
}

function showMessage(info, message) {
    console.log(info + ": " + message);
}

const button = document.getElementById('join-channel-button');
button.addEventListener('click', async () => await startSignaling());
</script>